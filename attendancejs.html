<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MIS Attendance Calculator</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        padding: 20px;
    }
    textarea {
        width: 100%;
        height: 260px;
        padding: 12px;
        font-family: monospace;
        font-size: 14px;
    }
    button {
        margin-top: 10px;
        padding: 10px 22px;
        font-size: 16px;
        cursor: pointer;
    }
    .box {
        background: #fff;
        padding: 16px;
        margin-top: 20px;
        border-radius: 6px;
    }
    .short {
        color: #c0392b;
        font-weight: bold;
    }
    .extra {
        color: #27ae60;
        font-weight: bold;
    }
    .today {
        color: #2980b9;
        font-weight: bold;
    }
    ul {
        padding-left: 20px;
    }
    hr {
        margin: 15px 0;
    }
</style>
</head>

<body>

<h1>üìã MIS Punch Copy-Paste Tool</h1>
<p>Paste raw punch data exactly as downloaded from MIS:</p>

<textarea id="input" placeholder="Please enter your date and time details
"></textarea>

<br>
<button onclick="calculate()">Calculate</button>

<div id="output"></div>

<script>
const REQUIRED_HOURS_PER_DAY = 8;

function calculate() {
    const raw = document.getElementById("input").value.trim();
    const output = document.getElementById("output");
    output.innerHTML = "";

    if (!raw) {
        output.innerHTML = "<p>Please paste MIS data.</p>";
        return;
    }

    const blocks = raw.split(/\n(?=N\d+)/);

    let totalSeconds = 0;
    let workingDays = 0;
    let lastPunchToday = null;

    const results = [];

    blocks.forEach((block, index) => {
        const lines = block.split("\n").map(l => l.trim()).filter(Boolean);
        if (lines.length < 2) return;

        const date = lines[1];
        const isToday = index === blocks.length - 1;

        // Absent
        if (block.toLowerCase().includes("absent")) {
            results.push({ date, text: "Absent" });
            return;
        }

        const matches = block.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/g);

        if (isToday && matches && matches.length) {
            lastPunchToday = new Date(matches[matches.length - 1].replace(" ", "T"));
        }

        // Single punch ‚Üí 0 hours, but working day
        if (matches && matches.length === 1) {
            workingDays++;
            results.push({ date, text: "Single Punch (0:00)" });
            return;
        }

        if (!matches || matches.length < 2) {
            results.push({ date, text: "Incomplete Punch" });
            return;
        }

        let seconds = 0;
        for (let i = 0; i < matches.length - 1; i += 2) {
            const inTime = new Date(matches[i].replace(" ", "T"));
            const outTime = new Date(matches[i + 1].replace(" ", "T"));
            seconds += (outTime - inTime) / 1000;
        }

        totalSeconds += seconds;
        workingDays++;

        results.push({
            date,
            text: formatDuration(seconds)
        });
    });

    let html = `<div class="box"><h2>üìä Daily Results</h2><ul>`;
    results.forEach(r => {
        html += `<li><strong>${r.date}:</strong> ${r.text}</li>`;
    });
    html += `</ul><hr>`;

    if (workingDays === 0) {
        output.innerHTML = html + "<p>No working days found.</p></div>";
        return;
    }

    const requiredSeconds = workingDays * REQUIRED_HOURS_PER_DAY * 3600;
    const diff = totalSeconds - requiredSeconds;
    const avg = (totalSeconds / 3600 / workingDays).toFixed(2);

    html += `<p><strong>Average Hours:</strong> ${avg} hrs</p>`;

    let todayToCover = 0;

    if (diff < 0) {
        todayToCover = -diff;
        html += `<p class="short">‚ùå SHORT by: ${formatDuration(todayToCover)}</p>`;
    } else {
        html += `<p class="extra">‚úÖ EXTRA by: ${formatDuration(diff)}</p>`;
    }

    if (todayToCover > 0) {
        html += `<p class="today">‚è± Time to be covered today: ${formatDuration(todayToCover)}</p>`;

        if (lastPunchToday) {
            const checkout = new Date(lastPunchToday.getTime() + todayToCover * 1000);
            html += `<p class="today">üïî You should check out at: <strong>${formatTime(checkout)}</strong></p>`;
        }
    }

    html += `</div>`;
    output.innerHTML = html;
}

// Helpers
function formatDuration(seconds) {
    seconds = Math.floor(seconds);
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function formatTime(date) {
    return `${String(date.getHours()).padStart(2,"0")}:${String(date.getMinutes()).padStart(2,"0")}`;
}
</script>

</body>
</html>
